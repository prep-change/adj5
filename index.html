<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>釣銭準備</title>
  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      const yenTypes = [10000, 5000, 1000, 500, 100, 50, 10, 5, 1];
      const target = { 5000: 15, 1000: 42, 500: 50, 100: 100, 50: 50, 10: 100, 5: 16, 1: 20 };

      function createInputs() {
        const container = document.getElementById("inputs");
        yenTypes.forEach((yen) => {
          const div = document.createElement("div");
          div.className = "flex justify-between items-center mb-1";
          div.innerHTML = `
            <label class="w-16">${yen}円</label>
            <input id="input-${yen}" type="number" min="0" value="0"
              class="w-24 p-1 border rounded text-right" />
          `;
          container.appendChild(div);
        });
      }

      function getInputValues() {
        const result = {};
        yenTypes.forEach((yen) => {
          result[yen] = parseInt(document.getElementById(`input-${yen}`).value) || 0;
        });
        return result;
      }

      function calculateShortage(input) {
        const shortage = {};
        for (const yen in target) {
          const t = target[yen];
          const i = input[yen] || 0;
          if (i < t) shortage[yen] = t - i;
        }
        return shortage;
      }

      function formatShortage(shortage) {
        if (Object.keys(shortage).length === 0) return "不足なし";
        return Object.entries(shortage)
          .map(([yen, num]) => `${yen}円 × ${num}枚`)
          .join(", ");
      }

      function generateAdjustmentPatterns(shortage, maxIncrement = 4) {
        const keys = Object.keys(shortage);
        const results = [];

        function backtrack(index, current) {
          if (index === keys.length) {
            results.push({ ...current });
            return;
          }
          const key = keys[index];
          const maxAdd = maxIncrement;
          for (let add = 0; add <= maxAdd; add++) {
            current[key] = shortage[key] + add;
            backtrack(index + 1, current);
          }
        }

        backtrack(0, {});
        return results;
      }

      function getTotalValue(counts) {
        return Object.entries(counts).reduce(
          (sum, [yen, num]) => sum + parseInt(yen) * num,
          0
        );
      }

      function compensate(shortagePattern, input) {
        const shortageTotal = getTotalValue(shortagePattern);
        const stock = { ...input };
        yenTypes.forEach((yen) => {
          stock[yen] = (stock[yen] || 0) - (shortagePattern[yen] || 0);
        });

        const compensation = {};
        let remaining = shortageTotal;

        for (const yen of yenTypes) {
          const available = stock[yen] || 0;
          const count = Math.min(Math.floor(remaining / yen), available);
          if (count > 0) {
            compensation[yen] = count;
            remaining -= yen * count;
          }
        }

        return remaining === 0 ? compensation : null;
      }

      function formatCompensation(comp) {
        if (!comp) return "補填不能";
        return Object.entries(comp)
          .map(([yen, num]) => `${yen}円 × ${num}枚`)
          .join(", ");
      }

      function calculate() {
        const input = getInputValues();
        const shortage = calculateShortage(input);
        document.getElementById("shortage").textContent = formatShortage(shortage);

        const patterns = generateAdjustmentPatterns(shortage, 4);
        let best = null;

        for (const pattern of patterns) {
          const comp = compensate(pattern, input);
          if (comp) {
            best = { pattern, comp };
            break; // 最短解を即採用
          }
        }

        if (best) {
          const display = formatShortage(best.pattern) + " → " + formatCompensation(best.comp);
          document.getElementById("result").textContent = display;
        } else {
          document.getElementById("result").textContent = "補填できる組み合わせが見つかりませんでした。";
        }
      }

      document.getElementById("calc").addEventListener("click", calculate);
      createInputs();
    });
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-md mx-auto bg-white p-4 rounded shadow">
    <h1 class="text-xl font-bold mb-4">釣銭準備ツール</h1>
    <div id="inputs" class="mb-4"></div>
    <button id="calc" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full">計算する</button>
    <div class="mt-4">
      <p><strong>不足金種:</strong> <span id="shortage" class="text-red-600"></span></p>
      <p><strong>補填内訳:</strong> <span id="result" class="text-green-600"></span></p>
    </div>
  </div>
</body>
</html>
